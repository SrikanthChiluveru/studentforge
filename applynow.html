<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apply Now | Student Forge (Mock OTP)</title>
  <link rel="icon" href="assets/temp_logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f3f4f6; color:#111827; }
    .card { background:white; max-width:760px; margin:32px auto; padding:24px; border-radius:12px; box-shadow:0 6px 24px rgba(15,23,42,.06); }
    .field { margin-bottom:12px; }
    input, select, textarea { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e5e7eb; background:#fff; }
    button { padding:10px 14px; border-radius:8px; cursor:pointer; border:0; }
    .btn-primary { background:#003153; color:white; }
    .btn-success { background:#16a34a; color:white; }
    .btn-muted { background:#6b7280; color:white; }
    .otp-box { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .small { font-size:13px; color:#6b7280; }
    .hidden { display:none; }
    .badge { display:inline-block; padding:6px 8px; border-radius:999px; background:#ecfeff; color:#0369a1; font-weight:600; font-size:13px; }


  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- Firebase SDK (compat builds for namespaced API) -->
  <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-auth-compat.js"></script>

<script>
  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDZ9y9QrrdFK9PNwn4DxlqNKz1Ofs-DQ2g",
    authDomain: "studentforge-1a3de.firebaseapp.com",
    projectId: "studentforge-1a3de",
    storageBucket: "studentforge-1a3de.firebasestorage.app",
    messagingSenderId: "997926101451",
    appId: "1:997926101451:web:31cdfa4cc2e82660b7964e",
    measurementId: "G-2XQ4F9ECGL"
  };
  firebase.initializeApp(firebaseConfig);
</script>

</head>
<body>
  <div id="nav-placeholder"></div>
  <!-- Loader Animation -->
  <div id="loaderOverlay" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
      <span class="text-white text-lg font-semibold">Processing Payment...</span>
    </div>
  </div>
 <div class="max-w-lg mx-auto mt-12 p-8 bg-white shadow-lg rounded-xl border border-gray-200">
  <h1 class="text-2xl font-bold mb-2 text-gray-900">Enroll to Student Forge</h1>
  <p class="text-gray-600 mb-6">Fill details below ‚Üí verify OTP (testing) ‚Üí proceed to payment.</p>

  <form id="applyForm" onsubmit="return false;" class="space-y-4">
<!-- Course Selection -->
<div>
  <label class="block text-gray-700 font-medium mb-1">Select Course</label>
  <select id="courseSelect" required
    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white text-gray-700">
    <option value="" disabled selected>Select a course</option>
  </select>
</div>

<!-- Show Price -->
<div class="mt-2">
  <p class="text-gray-800 font-medium">Total Price: ‚Çπ<span id="coursePrice">0</span></p>
</div>

    <!-- Name -->
    <div>
      <label class="block text-gray-700 font-medium mb-1">Name</label>
      <input id="name" name="name" type="text" placeholder="Full name" required
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
    </div>

    <!-- College / Business Name -->
    <div>
      <label class="block text-gray-700 font-medium mb-1">College / Business Name</label>
      <input id="bname" name="bname" type="text" placeholder="College / Business name" required
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
    </div>

    <!-- Email -->
    <div>
      <label class="block text-gray-700 font-medium mb-1">Email</label>
      <input id="email" name="email" type="email" placeholder="you@example.com" required
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
    </div>

    <!-- Mobile -->
    <div>
      <label class="block text-gray-700 font-medium mb-1">Mobile Number</label>
      <input id="phone" name="phone" type="tel" placeholder="10-digit mobile (e.g. 9876543210)" pattern="[0-9]{10}" maxlength="10" required
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
      <p class="text-sm text-gray-500 mt-1">OTP will be generated for demo and printed in console (testing only).</p>
    <div id="recaptcha-container" class="mt-2"></div>
    </div>

    <!-- Category -->
    <div>
      <label class="block text-gray-700 font-medium mb-1">Category</label>
      <select id="interest" name="interest" required
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white text-gray-700">
        <option value="" disabled selected>Category</option>
        <option value="learning">Learn with Forge</option>
        <option value="building">Build with Forge</option>
        <option value="mentoring">Join with Forge</option>
      </select>
    </div>

    <!-- Message -->
    <div>
      <label class="block text-gray-700 font-medium mb-1">Message</label>
      <textarea id="message" name="message" rows="4" placeholder="Your message..." required
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></textarea>
    </div>

    <!-- Buttons -->
    <div class="flex flex-wrap gap-3 mt-2">
      <button id="sendOtpBtn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Submit & Send OTP</button>
      <button id="proceedPayBtn" type="button" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition hidden">Proceed to Pay</button>
      <button id="resetBtn" type="button" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition">Reset</button>
    </div>

    <!-- OTP UI -->
    <div id="otpContainer" class="hidden mt-4 space-y-2">
      <div class="flex justify-between items-center">
        <div>
          <strong class="text-gray-800">Enter OTP</strong>
          <p class="text-sm text-gray-500" id="otpInstr">We sent a 6-digit OTP to your mobile. (Testing: OTP printed in console)</p>
        </div>
        <div id="otpStatus" class="text-sm text-right text-gray-600"></div>
      </div>

      <div class="flex gap-2 items-center">
        <input id="otpInput" type="text" placeholder="6-digit OTP" maxlength="6"
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
        <button id="verifyOtpBtn" type="button" class="bg-green-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-green-700 transition">Verify OTP</button>
        <button id="resendBtn" type="button" class="bg-gray-300 text-gray-700 px-3 py-2 rounded-lg font-semibold hover:bg-gray-400 transition">Resend</button>
      </div>

      <p class="text-sm text-gray-500 mt-1">
        Expires in <strong id="countdown">02:00</strong>
      </p>
    </div>
  </form>
</div>

<!-- Invoice Overlay -->
<div id="invoiceOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-xl p-6 max-w-md w-full relative">
    <span id="closeInvoice" class="absolute top-2 right-4 cursor-pointer font-bold text-xl">&times;</span>
    <h2 class="text-xl font-bold mb-2">Invoice</h2>
    <div id="invoiceContent" class="text-gray-800 text-sm"></div>
    <!-- <button id="downloadInvoice" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Download PDF</button> -->
  </div>
</div>
<div id="footer-placeholder"></div>

<script>
(() => {
async function loadCoursesForForm() {
  try {
    const res = await fetch("courses.json");
    const courses = await res.json();
    const select = document.getElementById("courseSelect");

    courses.forEach(c => {
      const opt = document.createElement("option");
      opt.value = JSON.stringify({ name: c.name, price: c.price });
      opt.textContent = `${c.name} ‚Äî ‚Çπ${c.price}`;
      select.appendChild(opt);
    });

    // Update when user selects
    select.addEventListener("change", () => {
      const selected = JSON.parse(select.value);
      document.getElementById("coursePrice").textContent = selected.price;
      window.selectedCourse = selected; // store globally
    });

    // If the page was opened with ?course=...&price=..., preselect that course
    try {
      const params = new URLSearchParams(window.location.search);
      const courseParam = params.get('course');
      const priceParam = params.get('price');
      if (courseParam) {
        // Try to find existing option matching the course name
        let found = null;
        for (const opt of Array.from(select.options)) {
          if (!opt.value) continue;
          try {
            const val = JSON.parse(opt.value);
            if (val && String(val.name) === courseParam) { found = val; select.value = opt.value; break; }
          } catch (e) { /* ignore */ }
        }

        // If not found in courses.json, inject a new option
        if (!found) {
          const injected = { name: courseParam, price: Number(priceParam) || 0 };
          const opt = document.createElement('option');
          opt.value = JSON.stringify(injected);
          opt.textContent = `${injected.name} ‚Äî ‚Çπ${injected.price}`;
          select.appendChild(opt);
          select.value = opt.value;
          found = injected;
        }

        // Apply the selection to UI/state
        const sel = found || null;
        if (sel) {
          document.getElementById('coursePrice').textContent = sel.price;
          window.selectedCourse = sel;
        }
      }
    } catch (err) {
      console.warn('Could not parse URL params for course preselect', err);
    }
  } catch (err) {
    console.error("‚ùå Failed to load courses.json", err);
  }
}
loadCoursesForForm();
  const applyForm = document.getElementById('applyForm');
  const sendOtpBtn = document.getElementById('sendOtpBtn');
  const proceedPayBtn = document.getElementById('proceedPayBtn');
  const resetBtn = document.getElementById('resetBtn');
  const otpContainer = document.getElementById('otpContainer');
  const otpInput = document.getElementById('otpInput');
  const verifyOtpBtn = document.getElementById('verifyOtpBtn');
  const resendBtn = document.getElementById('resendBtn');
  const countdownEl = document.getElementById('countdown');
  const otpStatus = document.getElementById('otpStatus');

  // Timers / state for OTP UX
  let countdownTimer = null;
  let resendCooldownTimer = null;
  const RESEND_COOLDOWN = 30; // seconds before user can request resend
  const OTP_EXPIRY = 120; // OTP validity in seconds shown to user

  // Firebase phone auth flow (production-ready)
  let confirmationResult = null;

 function initRecaptcha() {
  try {
    // If already initialized, skip re-creating/rendering it
    if (window.recaptchaInitialized) {
      return;
    }

    // Clear any previous verifier instance if present (best-effort)
    if (window.recaptchaVerifier) {
      try { window.recaptchaVerifier.clear(); } catch(e) { /* ignore */ }
      try { delete window.recaptchaVerifier; } catch(e) {}
    }

    // Use invisible reCAPTCHA on very small screens to avoid layout issues.
    const isVerySmall = window.innerWidth <= 420; // phones
    const isSmall = window.innerWidth <= 640;

    const opts = {
      size: isVerySmall ? 'invisible' : 'normal',
      callback: () => console.log('reCAPTCHA resolved')
    };

    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', opts);
    window.recaptchaVerifier.render().then(widgetId => {
      window.recaptchaWidgetId = widgetId;
      window.recaptchaInitialized = true;
      // If using invisible mode, hide the visible container to free layout space
      const rc = document.getElementById('recaptcha-container');
      if (rc) {
        if (isVerySmall) {
          rc.style.display = 'none';
        } else if (isSmall) {
          // slightly scale down reCAPTCHA on small screens
          rc.style.transform = 'scale(0.85)';
          rc.style.transformOrigin = 'left top';
        } else {
          rc.style.transform = '';
          rc.style.display = '';
        }
      }
    }).catch(err => {
      // ignore 'already been rendered' error which happens when initRecaptcha is called multiple times
      if (err && err.message && err.message.indexOf('already been rendered') !== -1) {
        console.warn('reCAPTCHA already rendered - continuing');
        window.recaptchaInitialized = true;
      } else {
        console.warn('recaptcha render error', err);
      }
    });
  } catch (err) {
    console.warn('initRecaptcha failed', err);
  }
}


  // Send OTP using Firebase
  sendOtpBtn.addEventListener('click', async () => {
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const phoneVal = document.getElementById('phone').value.trim();
    const interest = document.getElementById('interest').value;

    if (!name || !email || !phoneVal || !interest) {
      alert('Please fill all required fields before requesting OTP.');
      return;
    }
    if (!/^\d{10}$/.test(phoneVal)) {
      alert('Please enter a valid 10-digit phone number.');
      return;
    }

    initRecaptcha();
    if (!window.recaptchaVerifier) {
      console.error("‚ùå Recaptcha not initialized!");
      otpStatus.textContent = '‚ùå reCAPTCHA not ready. Try refreshing the page.';
      return;
    }

    const phone = '+91' + phoneVal;
    try {
      otpStatus.textContent = 'Sending OTP...';
      sendOtpBtn.disabled = true;
      confirmationResult = await firebase.auth().signInWithPhoneNumber(phone, window.recaptchaVerifier);
      otpStatus.textContent = '‚úÖ OTP sent';
      otpContainer.classList.remove('hidden');

      // Start OTP expiry countdown UI
      startOtpCountdown(OTP_EXPIRY);

      // Start resend cooldown
      disableResendFor(RESEND_COOLDOWN);
    } catch (err) {
      console.error('sendOtp error', err);
      otpStatus.textContent = '‚ùå ' + friendlyError(err);
      sendOtpBtn.disabled = false;
      // reset recaptcha if needed
      if (window.recaptchaVerifier) window.recaptchaVerifier.clear && window.recaptchaVerifier.clear();
    }
  });

  // Resend: re-init recaptcha and call signInWithPhoneNumber again
  resendBtn.addEventListener('click', async () => {
    const phoneVal = document.getElementById('phone').value.trim();
    if (!/^\d{10}$/.test(phoneVal)) { alert('Enter a valid phone to resend'); return; }
    if (resendBtn.disabled) return;
    initRecaptcha();
    try {
      otpStatus.textContent = 'Resending OTP...';
      resendBtn.disabled = true;
      confirmationResult = await firebase.auth().signInWithPhoneNumber('+91' + phoneVal, window.recaptchaVerifier);
      otpStatus.textContent = '‚úÖ OTP resent';
      otpContainer.classList.remove('hidden');

      // Restart OTP expiry and resend cooldown
      startOtpCountdown(OTP_EXPIRY);
      disableResendFor(RESEND_COOLDOWN);
    } catch (err) {
      console.error('resend error', err);
      otpStatus.textContent = '‚ùå ' + friendlyError(err);
      resendBtn.disabled = false;
      if (window.recaptchaVerifier) window.recaptchaVerifier.clear && window.recaptchaVerifier.clear();
    }
  });

  // Verify OTP
  verifyOtpBtn.addEventListener('click', async () => {
    const otp = otpInput.value.trim();
    if (!confirmationResult) { alert('Send OTP first'); return; }
    if (!otp || otp.length !== 6) { alert('Enter 6-digit OTP'); return; }

    try {
      const result = await confirmationResult.confirm(otp);
      const user = result.user;
      otpStatus.textContent = 'üéâ Phone verified';
      otpInput.disabled = true;
      verifyOtpBtn.disabled = true;
      proceedPayBtn.classList.remove('hidden');

      // Send verified phone to server (optional)
      // Grab ID token (JWT) to allow server-side verification of this auth session
      let idToken = null;
      try {
        idToken = await user.getIdToken();
      } catch (tErr) { console.warn('Could not get idToken', tErr); }

      fetch('https://sf-backend-c4so.onrender.com/verify_phone', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: user.phoneNumber, idToken })
      }).then(r => r.json()).then(d => console.log('server verify phone:', d)).catch(() => {});

      // After verification, submit the form data to Google Sheets (same flow as before)
      try {
        document.getElementById('loaderOverlay').classList.remove('hidden');
        const formData = new FormData(applyForm);
        formData.append('timestamp', new Date().toLocaleString());
        if (window.selectedCourse) { formData.append('course', window.selectedCourse.name); formData.append('price', window.selectedCourse.price); }
        else { formData.append('course','Not selected'); formData.append('price','0'); }

        const resp = await fetch('https://script.google.com/macros/s/AKfycbzEkwnxYaGi0-DhOpFjg8E6Wi0vnRPy2h9j_5OfIhwGq1hPE0GztTRTelNwHkfHPK6f/exec', { method: 'POST', body: formData });
        setTimeout(()=>{ document.getElementById('loaderOverlay').classList.add('hidden'); if (resp.status===200) proceedPayBtn.classList.remove('hidden'); else alert('Failed to submit data to Google Sheets'); }, 1200);
      } catch (err) { document.getElementById('loaderOverlay').classList.add('hidden'); console.error('sheets err', err); }

    } catch (err) {
      console.error('confirm error', err);
      otpStatus.textContent = '‚ùå ' + friendlyError(err);
    }
  });
  
  // Reset form to initial state
  resetBtn.addEventListener('click', ()=> {
    // clear timers
    if (countdownTimer) clearInterval(countdownTimer);
    if (resendCooldownTimer) clearInterval(resendCooldownTimer);
    confirmationResult = null;
    // sign out firebase user state if any
    try { firebase.auth().signOut().catch(()=>{}); } catch(e) {}
    otpContainer.classList.add('hidden');
    otpInput.value = '';
    otpInput.disabled = false;
    verifyOtpBtn.disabled = false;
    resendBtn.disabled = false;
    sendOtpBtn.disabled = false;
    sendOtpBtn.textContent = 'Submit & Send OTP';
    proceedPayBtn.classList.add('hidden');
    otpStatus.textContent = '';
    countdownEl.textContent = '02:00';
    // optionally clear form fields
    // applyForm.reset();
    // Attempt to clear reCAPTCHA so it can be re-rendered later without error
    try {
      if (window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function') {
        window.recaptchaVerifier.clear();
      }
      window.recaptchaInitialized = false;
      // clear recaptcha container markup (widget may recreate it cleanly)
      const rc = document.getElementById('recaptcha-container'); if (rc) rc.innerHTML = '';
      delete window.recaptchaVerifier;
      delete window.recaptchaWidgetId;
    } catch(e) { /* ignore */ }
  });

  // Helper: start OTP countdown and update UI
  function startOtpCountdown(seconds) {
    if (countdownTimer) clearInterval(countdownTimer);
    let remaining = seconds;
    updateCountdown(remaining);
    countdownTimer = setInterval(() => {
      remaining -= 1;
      updateCountdown(remaining);
      if (remaining <= 0) {
        clearInterval(countdownTimer);
        otpStatus.textContent = '‚è≥ OTP expired. Please resend.';
        // allow resend
        resendBtn.disabled = false;
        sendOtpBtn.disabled = false;
      }
    }, 1000);
  }

  function updateCountdown(seconds) {
    const mm = String(Math.floor(seconds/60)).padStart(2,'0');
    const ss = String(seconds%60).padStart(2,'0');
    countdownEl.textContent = `${mm}:${ss}`;
  }

  function disableResendFor(seconds) {
    if (resendCooldownTimer) clearInterval(resendCooldownTimer);
    resendBtn.disabled = true;
    let remaining = seconds;
    resendCooldownTimer = setInterval(() => {
      remaining -= 1;
      if (remaining <= 0) {
        resendBtn.disabled = false;
        clearInterval(resendCooldownTimer);
      }
    }, 1000);
  }

  // Friendly mapping for Firebase errors
  function friendlyError(err) {
    if (!err) return 'An unknown error occurred';
    const code = err.code || err.message || String(err);
    if (code.indexOf && code.indexOf('auth/invalid-phone-number') !== -1) return 'Invalid phone number.';
    if (code.indexOf && code.indexOf('auth/too-many-requests') !== -1) return 'Too many attempts. Try again later.';
    if (code.indexOf && code.indexOf('auth/quota-exceeded') !== -1) return 'SMS quota exceeded for this project.';
    if (code.indexOf && code.indexOf('auth/billing-not-enabled') !== -1) return 'SMS sending requires enabling billing on your Firebase project or use test phone numbers.';
    return (err.message && err.message.substring(0,200)) || String(err);
  }

  // Proceed button (user may manually click)
  proceedPayBtn.addEventListener('click', openRazorpayCheckout);
async function openRazorpayCheckout() {
  if (!window.selectedCourse) {
    alert("Select a course first");
    return;
  }

  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();
  const phone = document.getElementById('phone').value.trim();

  if (!name || !email || !phone) {
    alert('Fill all user details first');
    return;
  }

  try {
    // Step 1: Request server to create order
    const orderResp = await fetch('https://sf-backend-c4so.onrender.com/create_order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ course: window.selectedCourse.name })
    });
    const orderData = await orderResp.json();

    if (orderData.error) {
      alert("Order creation failed: " + orderData.error);
      return;
    }

    // Step 2: Open Razorpay Checkout
    const options = {
      key: 'rzp_test_RQUvSCLKCFnWZH', // Test key ok to expose
      amount: orderData.amount,
      currency: orderData.currency,
      name: "Student Forge",
      description: orderData.course,
      order_id: orderData.order_id,
      prefill: { name, email, contact: phone },
      handler: async function(response) {
        console.log("Razorpay response:", response);

        // Step 3: Verify payment with server
        const verifyResp = await fetch('https://sf-backend-c4so.onrender.com/verify_payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            order_id: response.razorpay_order_id,
            payment_id: response.razorpay_payment_id,
            signature: response.razorpay_signature
          })
        });
        const verifyData = await verifyResp.json();

        if (verifyData.valid) {
          // Show loader
          document.getElementById('loaderOverlay').classList.remove('hidden');

          // ‚úÖ Existing Google Sheet / OTP flow remains
          // You can now send paymentId + timestamp to Google Sheet
          const formData = new FormData(applyForm);
          formData.append('paymentId', response.razorpay_payment_id);
          formData.append('timestamp', new Date().toISOString());
          formData.append('course', window.selectedCourse.name);
          formData.append('price', window.selectedCourse.price);

          await fetch('https://script.google.com/macros/s/AKfycbyaG3OIrsRulSa1bA75UexqdylgmOHorOA2wIAI4ApydyoesNOt9R1R_qP_pEg8esXO/exec', { method: 'POST', body: formData });

          // Simulate loading for 1.5s (or until invoice is ready)
          setTimeout(() => {
            document.getElementById('loaderOverlay').classList.add('hidden');
            // Show invoice overlay
            document.getElementById('invoiceContent').innerHTML = `
              <p><strong>Course:</strong> ${window.selectedCourse.name}</p>
              <p><strong>Price:</strong> ‚Çπ${window.selectedCourse.price}</p>
              <p><strong>Name:</strong> ${name}</p>
              <p><strong>Email:</strong> ${email}</p>
              <p><strong>Phone:</strong> ${phone}</p>
              <p><strong>Payment ID:</strong> ${response.razorpay_payment_id}</p>
            `;
            document.getElementById('invoiceOverlay').classList.remove('hidden');
          }, 1500);

        } else {
          alert('Payment verification failed. Contact support.');
        }
      },
      theme: { color: "#003153" }
    };

    const rzp = new Razorpay(options);
    rzp.open();

  } catch (err) {
    console.error("Payment error:", err);
    alert("Error initiating payment. Try again.");
  }
}


//-----------------
function downloadInvoicePDF() {
  const overlay = document.getElementById('invoiceOverlay');
  const element = document.getElementById('invoiceContent');

  // Make overlay and content visible temporarily
  overlay.style.display = 'flex';
  element.style.display = 'block';

  // Give the DOM a tick to render
  setTimeout(() => {
    html2pdf()
      .set({
        margin: 0.5,
        filename: `${window.selectedCourse.name}_Invoice.pdf`,
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      })
      .from(element)
      .save();
  }, 100);
}


document.addEventListener('DOMContentLoaded', function () {
    // Initialize reCAPTCHA widget so the rc-anchor-container is visible on page load
    try {
      if (typeof initRecaptcha === 'function') {
        initRecaptcha();
      } else {
        console.warn('initRecaptcha not available yet');
      }
    } catch (e) {
      console.warn('Error initializing reCAPTCHA on load', e);
    }

    // Load nav and footer only after whole DOM & Tailwind are ready
    loadHTML("#nav-placeholder", "nav.html");
    loadHTML("#footer-placeholder", "footer.html");
});



// document.getElementById('downloadInvoice').addEventListener('click', downloadInvoicePDF);

function loadHTML(selector, file) {
            fetch(file)
                .then(response => {
                    if (!response.ok) throw new Error(`Could not fetch ${file}`);
                    return response.text();
                })
                .then(data => {
                    document.querySelector(selector).innerHTML = data;

                    // Re-run nav JS after loading nav dynamically
                    if (selector === "#nav-placeholder") {
                        const hamburger = document.getElementById('hamburger-menu');
                        const mobileNav = document.getElementById('mobile-nav');
                        if(hamburger && mobileNav) {
                            hamburger.addEventListener('click', () => mobileNav.classList.toggle('open'));
                            document.addEventListener('click', e => {
                                if (!mobileNav.contains(e.target) && !hamburger.contains(e.target)) {
                                    mobileNav.classList.remove('open');
                                }
                            });
                        }

                        // Highlight active link
                        var links = document.querySelectorAll('.nav-zoom');
                        var current = window.location.pathname.split('/').pop();
                        links.forEach(link => {
                            if(link.getAttribute('href') === current) link.classList.add('active');
                        });
                    }
                })
                .catch(err => console.error(err));
        }

        // Load nav and footer
        loadHTML("#nav-placeholder", "nav.html");
        loadHTML("#footer-placeholder", "footer.html");

})();

</script>
</body>
</html>

